<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Time Clock</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-100 min-h-screen">
  <div class="max-w-4xl mx-auto p-6">
    <h1 class="text-4xl font-bold text-gray-800 mb-8 text-center">‚è∞ Time Clock</h1>

    <!-- Clock In/Out Section -->
    <div class="bg-white rounded-xl shadow-lg p-8 mb-8">
      <div class="flex flex-col sm:flex-row gap-4 items-center justify-center">
        <input
          type="text"
          id="employeeName"
          placeholder="Enter your name"
          class="flex-1 px-6 py-4 border-2 border-gray-300 rounded-xl text-xl focus:border-blue-500 focus:outline-none"
        >
        
        <button
          id="clockBtn"
          onclick="handleClock()"
          class="px-10 py-4 bg-green-500 hover:bg-green-600 text-white text-xl font-bold rounded-xl transition-all transform hover:scale-105"
        >
          ‚ñ∂Ô∏è Clock In
        </button>
      </div>

      <div id="status" class="mt-6 text-center hidden">
        <div class="inline-block px-6 py-3 rounded-lg text-lg font-medium"></div>
      </div>

      <!-- Current Timer -->
      <div id="currentSession" class="mt-6 text-center hidden">
        <div class="bg-blue-50 rounded-xl p-6">
          <p class="text-gray-600 mb-2">Current Session</p>
          <p id="timer" class="text-5xl font-bold text-blue-600">00:00:00</p>
        </div>
      </div>
    </div>

    <!-- Stats -->
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-8">
      <div class="bg-white rounded-xl shadow p-6 text-center">
        <h3 class="text-lg font-semibold text-gray-600 mb-2">üìÖ Today</h3>
        <p id="todayTotal" class="text-4xl font-bold text-blue-600">0h 0m</p>
      </div>
      <div class="bg-white rounded-xl shadow p-6 text-center">
        <h3 class="text-lg font-semibold text-gray-600 mb-2">üìÜ This Week</h3>
        <p id="weekTotal" class="text-4xl font-bold text-purple-600">0h 0m</p>
      </div>
    </div>

    <!-- Entries -->
    <div class="bg-white rounded-xl shadow overflow-hidden">
      <div class="px-6 py-4 bg-gray-50 border-b">
        <h2 class="text-xl font-semibold">Recent Entries</h2>
      </div>
      
      <div id="entries" class="divide-y divide-gray-200 max-h-96 overflow-y-auto">
        <div class="p-8 text-center text-gray-500">Loading...</div>
      </div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://xybsaxjbtbpxpqwpbvmm.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh5YnNheGpidGJweHBxd3Bidm1tIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4MzMyMjAsImV4cCI6MjA4NjQwOTIyMH0.0tNbX0yGx8BTM67aGDWObj21JG_rfMJ6jOKIIS6uYsE';

    let currentEntry = null;
    let timerInterval = null;

    // Load saved name
    const savedName = localStorage.getItem('employeeName');
    if (savedName) {
      document.getElementById('employeeName').value = savedName;
    }

    // Check clock status on load
    checkClockStatus();
    fetchEntries();

    async function checkClockStatus() {
      const name = document.getElementById('employeeName').value;
      if (!name) return;

      const { data } = await supabaseFetch(
        `time_entries?employee_name=eq.${encodeURIComponent(name)}&clock_out=is.null&order=clock_in.desc&limit=1`
      );

      if (data && data.length > 0) {
        currentEntry = data[0];
        updateClockButton(true);
        startTimer(currentEntry.clock_in);
      }
    }

    async function handleClock() {
      const name = document.getElementById('employeeName').value.trim();
      if (!name) {
        alert('Please enter your name');
        return;
      }

      localStorage.setItem('employeeName', name);

      if (currentEntry) {
        // Clock out
        await supabasePatch(`time_entries?id=eq.${currentEntry.id}`, {
          clock_out: new Date().toISOString()
        });
        currentEntry = null;
        stopTimer();
        updateClockButton(false);
      } else {
        // Clock in
        const { data } = await supabasePost('time_entries', {
          employee_name: name,
          clock_in: new Date().toISOString()
        });
        if (data) {
          currentEntry = data[0];
          updateClockButton(true);
          startTimer(currentEntry.clock_in);
        }
      }

      fetchEntries();
    }

    function updateClockButton(clockedIn) {
      const btn = document.getElementById('clockBtn');
      const status = document.getElementById('status');
      const currentSession = document.getElementById('currentSession');
      const nameInput = document.getElementById('employeeName');

      if (clockedIn) {
        btn.innerHTML = 'üõë Clock Out';
        btn.className = 'px-10 py-4 bg-red-500 hover:bg-red-600 text-white text-xl font-bold rounded-xl transition-all transform hover:scale-105';
        status.querySelector('div').className = 'inline-block px-6 py-3 rounded-lg text-lg font-medium bg-green-100 text-green-800';
        status.querySelector('div').innerHTML = 'üü¢ Clocked In';
        status.classList.remove('hidden');
        currentSession.classList.remove('hidden');
        nameInput.disabled = true;
      } else {
        btn.innerHTML = '‚ñ∂Ô∏è Clock In';
        btn.className = 'px-10 py-4 bg-green-500 hover:bg-green-600 text-white text-xl font-bold rounded-xl transition-all transform hover:scale-105';
        status.classList.add('hidden');
        currentSession.classList.add('hidden');
        nameInput.disabled = false;
      }
    }

    function startTimer(clockIn) {
      const start = new Date(clockIn);
      
      function update() {
        const now = new Date();
        const diff = now - start;
        const hours = Math.floor(diff / (1000 * 60 * 60));
        const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const secs = Math.floor((diff % (1000 * 60)) / 1000);
        document.getElementById('timer').textContent = 
          `${String(hours).padStart(2, '0')}:${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
      }
      
      update();
      timerInterval = setInterval(update, 1000);
    }

    function stopTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
    }

    async function fetchEntries() {
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      const weekStart = new Date(today);
      weekStart.setDate(today.getDate() - today.getDay());

      const [todayData, weekData] = await Promise.all([
        supabaseFetch(`time_entries?clock_in=gte.${today.toISOString()}&order=clock_in.desc`),
        supabaseFetch(`time_entries?clock_in=gte.${weekStart.toISOString()}&order=clock_in.desc`)
      ]);

      // Today's total
      const todayMs = (todayData || []).reduce((sum, e) => {
        if (!e.clock_out) return sum;
        return sum + (new Date(e.clock_out) - new Date(e.clock_in));
      }, 0);

      // Week total
      const weekMs = (weekData || []).reduce((sum, e) => {
        if (!e.clock_out) return sum;
        return sum + (new Date(e.clock_out) - new Date(e.clock_in));
      }, 0);

      document.getElementById('todayTotal').textContent = formatDuration(todayMs);
      document.getElementById('weekTotal').textContent = formatDuration(weekMs);

      // Render entries
      const entriesEl = document.getElementById('entries');
      const entries = todayData || [];
      
      if (entries.length === 0) {
        entriesEl.innerHTML = '<div class="p-8 text-center text-gray-500">No entries today</div>';
        return;
      }

      entriesEl.innerHTML = entries.map(e => `
        <div class="p-4 flex items-center justify-between hover:bg-gray-50">
          <div>
            <p class="font-medium text-gray-900">${e.employee_name}</p>
            <p class="text-sm text-gray-500">
              ${formatDate(e.clock_in)} ‚Üí ${e.clock_out ? formatDate(e.clock_out) : 'Active'}
            </p>
          </div>
          <div class="text-right">
            <p class="font-bold ${e.clock_out ? 'text-gray-700' : 'text-green-600'}">
              ${formatDuration(e.clock_out ? new Date(e.clock_out) - new Date(e.clock_in) : new Date() - new Date(e.clock_in))}
            </p>
          </div>
        </div>
      `).join('');
    }

    function formatDuration(ms) {
      const hours = Math.floor(ms / (1000 * 60 * 60));
      const mins = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
      return `${hours}h ${mins}m`;
    }

    function formatDate(dateStr) {
      return new Date(dateStr).toLocaleTimeString('en-US', { 
        hour: '2-digit', 
        minute: '2-digit' 
      });
    }

    // Supabase helpers
    async function supabaseFetch(query) {
      try {
        const res = await fetch(`${SUPABASE_URL}/rest/v1/${query}`, {
          headers: {
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`
          }
        });
        return await res.json();
      } catch (e) {
        console.error(e);
        return [];
      }
    }

    async function supabasePost(table, data) {
      try {
        const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}`, {
          method: 'POST',
          headers: {
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`,
            'Content-Type': 'application/json',
            'Prefer': 'return=representation'
          },
          body: JSON.stringify(data)
        });
        return await res.json();
      } catch (e) {
        console.error(e);
        return null;
      }
    }

    async function supabasePatch(query, data) {
      try {
        await fetch(`${SUPABASE_URL}/rest/v1/${query}`, {
          method: 'PATCH',
          headers: {
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });
      } catch (e) {
        console.error(e);
      }
    }
  </script>
</body>
</html>
